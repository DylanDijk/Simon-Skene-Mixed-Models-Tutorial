[{"path":"index.html","id":"introduction","chapter":"1 Introduction","heading":"1 Introduction","text":"tutorial aims show methods described two papers Simon S. Skene Michael G. Kenward1,2 can applied mixed models R SAS.particular focus :Modified Box CorrectionScheffe contrastCan add go","code":""},{"path":"index.html","id":"sas","chapter":"1 Introduction","heading":"1.1 SAS","text":"analysis two papers carried using SAS.","code":""},{"path":"index.html","id":"r","chapter":"1 Introduction","heading":"1.2 R","text":"multiple packages R allow fit mixed models. popular nlme lme4 package. differences two packages described page 4 lme4 package documentation (https://cran.r-project.org/web/packages/lme4/lme4.pdf).main difference nlme package allows flexibility choosing complex variance-covariance structures. lme4 package allowing us select correlation structure individuals via random effects (G side).","code":""},{"path":"Modified-Box-Correction-SAS.html","id":"Modified-Box-Correction-SAS","chapter":"2 Modified Box Correction","heading":"2 Modified Box Correction","text":"","code":""},{"path":"Modified-Box-Correction-SAS.html","id":"example","chapter":"2 Modified Box Correction","heading":"2.1 Example","text":"best way show calculate modified box corrected F statistic example.\nshow present code used Simon Skene calculate results given paper.","code":"proc import datafile=\"S:\\Shared_Projects\\RO06_Surrey_CTU_Statistics\\Dylan\\Small samples\\R code\\Mixed-Models-Small-Sample-Tutorial-bs4\\Data_Images_Figures\\The Cardiac Enzyme Data - Reduced Data set.csv\"\n        out=cardiac_data\n        dbms=csv\n        replace;\n    \nrun;\nproc mixed data=cardiac_data;\nclass dog trt time;\nmodel atp=trt time trt*time/ ddfm=kr s;\nrepeated time/type=un subject=dog r=4;\nrun;\n\n\n\n\ntitle2 \"Inference Using Box Corrections\";\n\nproc iml;\n\nm=12; /* number of subjects */\np=9;  /* number of time points */\n\n\nuse d var{atp};\nread all;\n\ny=atp;\n\nuse rmat var{col1 col2 col3 col4 col5 col6 col7 col8 col9};\nread all;\nrmat=col1||col2||col3||col4||col5||col6||col7||col8||col9;\n\nSIGMA=rmat;\n\n\nic=j(m*p,1,1);\n\ntrt1=j(m*p/2,1,0)//j(m*p/2,1,1);\ntrt2=j(m*p/2,1,1)//j(m*p/2,1,0);\ntrt=trt2;\n\ntime=i(p);\ndo i=2 to m by 1;\n    time=time//i(p);\n    end;\ntime=time[,2:9];\n\nint=j(m*p,(p-1),.);\ndo i=1 to (p-1);\n   int[,i]=time[,i]#trt;\n   end;\n\nX=ic||trt||time||int;\nXr=ic||trt||time;\n\nparm=ncol(X);c=ncol(X)-ncol(Xr);\n\n\ntot=m*p;\nind=j(tot,1,1);\ndo i=1 to tot by 1;\n    if  y[i]=. then ind[i]=0;\nend;\nnobs=sum(ind);\n\nmobs=j(m,1,.);\ndo i=1 to m by 1;\n    mobs[i]=sum(ind[(i-1)*p+1:(i*p)]);\nend;\n\ncnt=j(m,1,.);\ndo i=1 to m by 1;\n    cnt[i]=sum(mobs[1:i]);\nend;\n\nyrem=y[loc(ind=1)];\nXrem=X[loc(ind=1),];\nXr_rem=Xr[loc(ind=1),];\n\n\nstart block_V(Mat) global(m);\n    ans=i(m)@Mat;\n    return(ans);\nfinish block_V;\n\nstart block_Vrem(Mat) global(m,p,cnt,mobs,nobs);\n    ans=j(nobs,nobs,0);\n    do i=1 to m by 1;\n        if mobs[i]=p then Mati=Mat;\n        else Mati=Mat[1:mobs[i],1:mobs[i]];\n        if i=1 then ans[1:cnt[1],1:cnt[1]]=Mati;\n        else ans[cnt[i-1]+1:cnt[i],cnt[i-1]+1:cnt[i]]=Mati;\n    end;\n    return(ans);\nfinish block_Vrem;\n\nVrem=block_Vrem(SIGMA);\n\n/* ANOVA F-test*/\n\nA=i(nobs)-Xrem*inv(t(Xrem)*Xrem)*t(Xrem);\nB=Xrem*inv(t(Xrem)*Xrem)*t(Xrem)-Xr_rem*inv(t(Xr_rem)*Xr_rem)*t(Xr_rem);\nF=(nobs-parm)#(t(yrem)*B*yrem)/(c#t(yrem)*A*yrem);\n\nnumdf=c;dendf=nobs-parm;\n\n/* Box Correction */\n\npsi=(nobs-parm)#trace(B*Vrem)/(c#trace(A*Vrem));\nv1_BOX=((trace(B*Vrem))##2)/trace(B*Vrem*B*Vrem);\nv2_BOX=((trace(A*Vrem))##2)/trace(A*Vrem*A*Vrem);\n\nF_BOX=F/psi;\n\n/* Modified Box Correction */\n\nE=trace(B*Vrem)/trace(A*Vrem);\nV=(trace(B*Vrem*B*Vrem)/((trace(B*Vrem))##2))+(trace(A*Vrem*A*Vrem)/((trace(A*Vrem))##2));\nv1_MOD=c;\nv2_MOD=(c#(4#V+1)-2)/(c#V-1);\nlambda=((nobs-parm)/c)#((v2_MOD-2)/v2_MOD)#E;\n*lambda=((nobs-parm)/c)#((v2-2)/v2)#E;\n\nF_MOD=F/lambda;\n\nprob_F=1-cdf(\"F\",F,numdf,dendf);\nprob_F_BOX=1-cdf(\"F\",F_BOX,v1_BOX,v2_BOX);\nprob_F_MOD=1-cdf(\"F\",F_MOD,v1_MOD,v2_MOD);\n\n/* Printing of results */\n\nprint / \"ANOVA F Statistic\";\nprint F numdf dendf prob_F;\n\nprint \"Box Correction\";\nprint psi F_BOX v1_BOX v2_BOX prob_F_BOX;\n\nprint \"Modified Box Correction\";\nprint lambda F_MOD v1_mod v2_mod prob_F_MOD;"},{"path":"modified-box-correction.html","id":"modified-box-correction","chapter":"3 Modified Box Correction","heading":"3 Modified Box Correction","text":"","code":""},{"path":"modified-box-correction.html","id":"nlme","chapter":"3 Modified Box Correction","heading":"3.1 nlme","text":"provide function calculates modified box correction mixed models constructed using nlme package.function takes input two nlme models, input variable model full model model_r model variables removed want test significance model.R session run code function R environment.Next give examples using function recreate results presented second paper.","code":"\n\nBox_correction_modified_nlme = function(model, model_r, data, Sigma = NULL){\n  \n  \n  \n  # Design matrix for full model\n  X <- model.matrix(model,data = data)\n  \n  ind = which(is.na(match(rownames(data),rownames(X))))\n\n  # Response variable vector\n  Y = getResponse(model)\n\n  \n  # Design matrix for model with removed variables\n  X_r <- model.matrix(model_r,data = data)\n  # Number of observations\n  n = nrow(X)\n  # Number of variables\n  parm = ncol(X)\n  # Number of variables being removed\n  c = ncol(X)-ncol(X_r)\n\n\n  # Have added option for Sigma to be chosen manually, this is needed for the Guinea pig example.\n  # By default the function takes Sigma to be NULL, so will be NULL unless manually defined.\n  \n  if(is.null(Sigma)){\n  \n      # Need to find good way of extracting covariance matrix from model\n        # Put in if statement to deal with models with no correlated errors\n      if(is.null(model$modelStruct$corStruct)){\n        \n        Sigma = diag((model$sigma)^2, nrow = n, ncol = n)\n      \n      } else {\n        # repeats = as.numeric(levels(model$groups))\n        \n        # Creating block matrix for model with correlated errors\n        Sigma = getVarCov(model, type = \"marginal\")\n        Sigma = diag(nlevels(model$groups)) %x% Sigma\n          if(!(length(ind) == 0)){\n            Sigma = Sigma[-ind,-ind]\n          }\n        }\n     \n    }\n     \n  \n  A = diag(n) - ( X %*% solve( t(X) %*% X ) %*% t(X) )\n  B = ( X %*% solve( t(X) %*% X ) %*% t(X) )  -  ( X_r %*% solve( t(X_r) %*% X_r ) %*% t(X_r) ) \n  \n  trace = function(x){\n    sum(diag(x))\n  }\n  \n  V = ( (trace((B %*% Sigma) %*% (B %*% Sigma)) / trace(B %*% Sigma)^2)\n        + (trace((A %*% Sigma) %*% (A %*% Sigma)) / trace(A %*% Sigma)^2) )   \n  \n  \n  v_2 = (c*(4*V + 1) - 2)/((c*V) - 1)\n  \n  lambda = ((n - parm)/c) * ((v_2 - 2)/v_2) * ((trace(B %*% Sigma) / trace(A %*% Sigma)))\n  \n  F_ =  ((n - parm)/c) * ((t(Y) %*% B %*% Y)/(t(Y) %*% A %*% Y))\n  \n  F_mod = F_/lambda\n  \n  p_value = pf(df1 = c, df2 = v_2, q =  F_mod, lower.tail = F)\n  \n  values = c(lambda, F_, F_mod, c, v_2, p_value)\n  names(values) = c(\"Lambda\", \"F_\",\"F_MOD\", \"v1_MOD\", \"v2_mod\", \"prob_F_mod\")\n  values = round(values, digits = 3)\n  \n  return(as.table(values))\n  \n}"},{"path":"modified-box-correction.html","id":"examples","chapter":"3 Modified Box Correction","heading":"3.2 Examples","text":"section look recreating examples given section 6 second paper.","code":""},{"path":"modified-box-correction.html","id":"cardiac-enzyme","chapter":"3 Modified Box Correction","heading":"3.2.1 Cardiac enzyme","text":"example covered Section 6.1 second paper3. Section 6.1 paper applies modified Box correction twice dataset, original versiona including artificial dropouts dataset.Importing dataset, converting selection variables factors.\nNeed select way people download file, just make Github repo csv file.creating nlme models. examples set glsControl(tolerance = 10^-8), match convergence criteria used nlme default convergence criteria used PROC MIXED SAS.can compare results Box_correction_modified_nlme() function results given upper panel Table VII second paper.addition computing p-value using modified Box corrected F statistic, can use lmerTest package compute p-values Table VII.p-values computed using Wald tests Kenward-Roger adjustment.weThe anova method S3 method class ‘lmerModLmerTest’ uses KRmodcomp function pbkrtest package. alternative previous method can use KRmodcomp function directly.","code":"\nCardiac_enzyme_data = read.csv(\"Data_Images_Figures/The Cardiac Enzyme Data - Reduced Data set.csv\")\nCardiac_enzyme_data$dog = as.factor(Cardiac_enzyme_data$dog)\nCardiac_enzyme_data$trt = as.factor(Cardiac_enzyme_data$trt)\nCardiac_enzyme_data$time = as.factor(Cardiac_enzyme_data$time)\nlibrary(nlme)\nglsControl(tolerance = 10^-8)\n\nmodel = gls(model = atp ~  trt + time + trt:time,\n            data = Cardiac_enzyme_data,\n            correlation = corSymm(form =~ as.numeric(time)|dog),\n            weights = varIdent(form =~ 1|time))\n\nmodel_r = gls(model = atp ~ trt + time,\n              data = Cardiac_enzyme_data,\n              correlation = corSymm(form =~ as.numeric(time)|dog),\n              weights = varIdent(form =~ 1|time))\nBox_correction_modified_nlme(data = Cardiac_enzyme_data, model = model, model_r = model_r)\nlibrary(lmerTest)\nm1 = lmerTest::lmer(atp ~  trt + time + trt:time + (1|dog),\n              data = Cardiac_enzyme_data)\n\nm1 = lme4::lmer(atp ~  trt + time + trt:time + (1|dog),\n              data = Cardiac_enzyme_data)\n\nanova(m1, ddf = \"Kenward-Roger\")\nlibrary(pbkrtest)\nm0 = lme4::lmer(atp ~ trt + time + (1|dog),\n                data = Cardiac_enzyme_data)\nKRmodcomp(m1,m0)"},{"path":"modified-box-correction.html","id":"cardiac-enzyme---artifical-missing-data","chapter":"3 Modified Box Correction","heading":"3.2.2 Cardiac enzyme - Artifical missing data","text":"results lower panel Table VII computed applying method dataset now artificial missing data introduced.Box_correction_modified_nlme() function works missing data.give R code compute results.first introduce missing data points Cardiac_enzyme_data used previous section.","code":"\nCardiac_enzyme_data_miss = Cardiac_enzyme_data\nCardiac_enzyme_data_miss$atp[which(Cardiac_enzyme_data_miss$dog == 4)][7:9] = NA\nlibrary(nlme)\nglsControl(tolerance = 10^-8)\n\n\nmodel = gls(model = atp ~  trt + time + trt:time,\n            data = Cardiac_enzyme_data_miss,\n            correlation = corSymm(form =~ as.numeric(time)|dog),\n            weights = varIdent(form =~ 1|time), na.action = na.omit)\n\nmodel_r = gls(model = atp ~ trt + time,\n              data = Cardiac_enzyme_data_miss,\n              correlation = corSymm(form =~ as.numeric(time)|dog),\n              weights = varIdent(form =~ 1|time), na.action = na.omit)\n\n\nBox_correction_modified_nlme(model = model, model_r = model_r, data = Cardiac_enzyme_data_miss)"},{"path":"modified-box-correction.html","id":"guinea-pigs","chapter":"3 Modified Box Correction","heading":"3.2.3 Guinea pigs","text":"Importing dataset.example Skene Kenward4 used sample covariance matrix estimator covariance matrix (\\(\\Sigma\\)). Therefore sample covariance estimates computed used inputs Sigma Box_correction_modified_nlme() function.Calculating sample covariance matrices.Creating models.Running Box_correction_modified_nlme() function.compound 1.compound 2.","code":"\nGuinea_pigs_data = read.csv(\"Data_Images_Figures/brammer.csv\")\n\nGuinea_pigs_data$conc.f = factor(Guinea_pigs_data$conc.f)\nsigma_compound_1 = cov(rbind(Guinea_pigs_data[1:7,1],Guinea_pigs_data[8:14,1],Guinea_pigs_data[15:21,1]))\nsigma_compound_2 = cov(rbind(Guinea_pigs_data[1:7,2],Guinea_pigs_data[8:14,2],Guinea_pigs_data[15:21,2]))\nm = 3 #no. subjects\n\nsigma_compound_1_block = diag(m) %x% sigma_compound_1\nsigma_compound_2_block = diag(m) %x% sigma_compound_2\nlibrary(nlme)\n\nmodel_AP1 = gls(AP1~conc.f,data=Guinea_pigs_data)\nmodel_AP1_r = gls(AP1~1,data=Guinea_pigs_data)\n\nmodel_AP2 = gls(AP2~conc.f,data=Guinea_pigs_data)\nmodel_AP2_r = gls(AP2~1,data=Guinea_pigs_data)\nBox_correction_modified_nlme(model = model_AP1, model_r = model_AP1_r, data = Guinea_pigs_data, Sigma = sigma_compound_1_block)\nBox_correction_modified_nlme(model = model_AP2, model_r = model_AP2_r, data = Guinea_pigs_data, Sigma = sigma_compound_2_block)"},{"path":"references.html","id":"references","chapter":"References","heading":"References","text":"","code":""}]
