<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 4 Modified Box Correction | Methods in (Skene &amp; Kenward, 2010)</title>
<meta name="author" content="Dylan Dijk">
<meta name="description" content="4.1 nlme The code below gives an R function that returns the modified Box correction and the corresponding p-value. The function uses mixed model objects from the nlme package to define the mean...">
<meta name="generator" content="bookdown 0.27 with bs4_book()">
<meta property="og:title" content="Chapter 4 Modified Box Correction | Methods in (Skene &amp; Kenward, 2010)">
<meta property="og:type" content="book">
<meta property="og:description" content="4.1 nlme The code below gives an R function that returns the modified Box correction and the corresponding p-value. The function uses mixed model objects from the nlme package to define the mean...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 4 Modified Box Correction | Methods in (Skene &amp; Kenward, 2010)">
<meta name="twitter:description" content="4.1 nlme The code below gives an R function that returns the modified Box correction and the corresponding p-value. The function uses mixed model objects from the nlme package to define the mean...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Methods in (Skene &amp; Kenward, 2010)</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Introduction</a></li>
<li class="book-part">SAS</li>
<li><a class="" href="Modified-Box-Correction-SAS.html"><span class="header-section-number">2</span> Modified Box Correction</a></li>
<li class="book-part">R</li>
<li><a class="" href="Sandwich-Estimator.html"><span class="header-section-number">3</span> Sandwich Estimator</a></li>
<li><a class="active" href="Modified-Box-Correction.html"><span class="header-section-number">4</span> Modified Box Correction</a></li>
<li><a class="" href="Scheffe-method.html"><span class="header-section-number">5</span> Scheffé’s method</a></li>
<li><a class="" href="References.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/DylanDijk/Simon-Skene-Mixed-Models-Tutorial">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="Modified-Box-Correction" class="section level1" number="4">
<h1>
<span class="header-section-number">4</span> Modified Box Correction<a class="anchor" aria-label="anchor" href="#Modified-Box-Correction"><i class="fas fa-link"></i></a>
</h1>
<div id="nlme" class="section level2" number="4.1">
<h2>
<span class="header-section-number">4.1</span> nlme<a class="anchor" aria-label="anchor" href="#nlme"><i class="fas fa-link"></i></a>
</h2>
<p>The code below gives an R function that returns the modified Box correction and the corresponding p-value. The function uses mixed model objects from the <strong>nlme</strong> package to define the mean model, and the structure of the covariance matrix that will be used. The preferred choice is to use an unstructured estimate, but when this is not possible we can compute an estimate of <span class="math inline">\(\Sigma\)</span> with the most complex structure the data will support.</p>
<p>The function requires two <strong>nlme</strong> models as input, the <code>model_r</code> variable should be the formula with the variables removed that you want to test significance for in the full model defined by the <code>model</code> variable.</p>
<p>The default estimate of <span class="math inline">\(\Sigma\)</span> is the REML estimate extracted from the model object defined by the <code>model</code> input variable. However, if you do want to use an alternative covariance estimate you can select it using the <code>Sigma</code> variable. For example in Section <a href="Modified-Box-Correction.html#Guinea-pigs">4.2.3</a> we use the sample covariance matrix.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/nlme/">nlme</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">Box_correction_modified_nlme</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">model_r</span>, <span class="va">data</span>, <span class="va">Sigma</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co"># Design matrix for full model</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="va">model</span>,data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Gives the rownumbers of the dataset that have missing values</span></span>
<span>  <span class="va">ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">Y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/getResponse.html">getResponse</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Design matrix for model with removed variables</span></span>
<span>  <span class="va">X_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="va">model_r</span>,data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="co"># Number of observations</span></span>
<span>  <span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>  <span class="co"># Number of variables</span></span>
<span>  <span class="va">parm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>  <span class="co"># Number of variables being removed</span></span>
<span>  <span class="va">c</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">X_r</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># Put in if statement to deal with models with no correlated errors</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">modelStruct</span><span class="op">$</span><span class="va">corStruct</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      </span>
<span>      <span class="va">Sigma</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">sigma</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># repeats = as.numeric(levels(model$groups))</span></span>
<span>      </span>
<span>      <span class="co"># Creating block matrix for model with correlated errors</span></span>
<span>      <span class="co"># type = "marginal" extracts the covariance matrix when </span></span>
<span>      <span class="co"># not conditioning on the random effects. Therefore extracts </span></span>
<span>      <span class="co"># the full covariance matrix G side and R side.</span></span>
<span>      <span class="va">Sigma</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/getVarCov.html">getVarCov</a></span><span class="op">(</span><span class="va">model</span>, type <span class="op">=</span> <span class="st">"marginal"</span><span class="op">)</span></span>
<span>      <span class="va">Sigma</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nlevels.html">nlevels</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">groups</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/kronecker.html">%x%</a></span> <span class="va">Sigma</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ind</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">Sigma</span> <span class="op">=</span> <span class="va">Sigma</span><span class="op">[</span><span class="op">-</span><span class="va">ind</span>,<span class="op">-</span><span class="va">ind</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">A</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/solve-methods.html">solve</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">X</span> <span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="va">B</span> <span class="op">=</span> <span class="op">(</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/solve-methods.html">solve</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">X</span> <span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">)</span>  <span class="op">-</span>  <span class="op">(</span> <span class="va">X_r</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/solve-methods.html">solve</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">X_r</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">X_r</span> <span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">X_r</span><span class="op">)</span> <span class="op">)</span> </span>
<span>  </span>
<span>  <span class="va">trace</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">V</span> <span class="op">=</span> <span class="op">(</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/trace.html">trace</a></span><span class="op">(</span><span class="op">(</span><span class="va">B</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">Sigma</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="op">(</span><span class="va">B</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">Sigma</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/trace.html">trace</a></span><span class="op">(</span><span class="va">B</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">Sigma</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>        <span class="op">+</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/trace.html">trace</a></span><span class="op">(</span><span class="op">(</span><span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">Sigma</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="op">(</span><span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">Sigma</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/trace.html">trace</a></span><span class="op">(</span><span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">Sigma</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">)</span>   </span>
<span>  </span>
<span>  </span>
<span>  <span class="va">v_2</span> <span class="op">=</span> <span class="op">(</span><span class="va">c</span><span class="op">*</span><span class="op">(</span><span class="fl">4</span><span class="op">*</span><span class="va">V</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="op">(</span><span class="va">c</span><span class="op">*</span><span class="va">V</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">lambda</span> <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="va">parm</span><span class="op">)</span><span class="op">/</span><span class="va">c</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="va">v_2</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">v_2</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/trace.html">trace</a></span><span class="op">(</span><span class="va">B</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">Sigma</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/trace.html">trace</a></span><span class="op">(</span><span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">Sigma</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">F_</span> <span class="op">=</span>  <span class="op">(</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="va">parm</span><span class="op">)</span><span class="op">/</span><span class="va">c</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">B</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">Y</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">F_mod</span> <span class="op">=</span> <span class="va">F_</span><span class="op">/</span><span class="va">lambda</span></span>
<span>  </span>
<span>  <span class="va">p_value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html">pf</a></span><span class="op">(</span>df1 <span class="op">=</span> <span class="va">c</span>, df2 <span class="op">=</span> <span class="va">v_2</span>, q <span class="op">=</span>  <span class="va">F_mod</span>, lower.tail <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">values</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">lambda</span>, <span class="va">F_</span>, <span class="va">c</span>, <span class="va">v_2</span>, <span class="va">F_mod</span>, <span class="va">p_value</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">values</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Lambda"</span>, <span class="st">"F_"</span>, <span class="st">"v1_MOD"</span>, <span class="st">"v2_mod"</span>,<span class="st">"F_MOD"</span>, <span class="st">"prob_F_mod"</span><span class="op">)</span></span>
<span>  <span class="va">values</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">values</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">fixed_effects_estimate</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/solve-methods.html">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span><span class="va">X</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span><span class="va">Y</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"Lambda"</span> <span class="op">=</span> <span class="va">lambda</span>, <span class="st">"F_"</span> <span class="op">=</span> <span class="va">F_</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"c"</span> <span class="op">=</span> <span class="va">c</span>, <span class="st">"v2_mod"</span> <span class="op">=</span> <span class="va">v_2</span>, <span class="st">"F_MOD"</span> <span class="op">=</span> <span class="va">F_mod</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,       </span>
<span>              <span class="st">"prob_F_mod"</span> <span class="op">=</span> <span class="va">p_value</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"A"</span> <span class="op">=</span> <span class="va">A</span>, <span class="st">"B"</span> <span class="op">=</span> <span class="va">B</span>, <span class="st">"n"</span> <span class="op">=</span> <span class="va">n</span>, <span class="st">"r"</span> <span class="op">=</span> <span class="va">parm</span>, <span class="st">"Y"</span> <span class="op">=</span> <span class="va">Y</span>,</span>
<span>              <span class="st">"fixed_effects_estimate"</span> <span class="op">=</span> <span class="va">fixed_effects_estimate</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>In your R session copy and run this code so that it is available in your R environment. Next we give some examples of applying the function to recreate results presented in the paper II.</p>
</div>
<div id="examples" class="section level2" number="4.2">
<h2>
<span class="header-section-number">4.2</span> Examples<a class="anchor" aria-label="anchor" href="#examples"><i class="fas fa-link"></i></a>
</h2>
<div id="cardiac-enzyme-1" class="section level3" number="4.2.1">
<h3>
<span class="header-section-number">4.2.1</span> Cardiac enzyme<a class="anchor" aria-label="anchor" href="#cardiac-enzyme-1"><i class="fas fa-link"></i></a>
</h3>
<p>In this example we look at the same dataset and mean model that was used in the example covered in Section 6.1 of paper II. We apply the <code>Box_correction_modified_nlme()</code> function to test for the inclusion of the interaction term between treatment and time in the model.</p>
<p>We apply the function with the original dataset and then to the dataset with artificial dropouts, to recreate the results of Table VII.</p>
<p>First of all we need to import the dataset. The code below imports the dataset from a GitHub repository, and converts a selection of the variables in the dataset to factors.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Cardiac_enzyme_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/DylanDijk/Simon-Skene-Mixed-Models-Tutorial/main/Data_Images_Figures/The%20Cardiac%20Enzyme%20Data%20-%20Reduced%20Data%20set.csv"</span><span class="op">)</span></span>
<span><span class="va">Cardiac_enzyme_data</span><span class="op">$</span><span class="va">dog</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">Cardiac_enzyme_data</span><span class="op">$</span><span class="va">dog</span><span class="op">)</span></span>
<span><span class="va">Cardiac_enzyme_data</span><span class="op">$</span><span class="va">trt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">Cardiac_enzyme_data</span><span class="op">$</span><span class="va">trt</span><span class="op">)</span></span>
<span><span class="va">Cardiac_enzyme_data</span><span class="op">$</span><span class="va">time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">Cardiac_enzyme_data</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span></code></pre></div>
<p>The code below creates the <strong>nlme</strong> models, a good resource documenting how to fit different mixed models with <strong>nlme</strong> is <a href="http://staff.pubhealth.ku.dk/~jufo/courses/rm2018/nlmePackage.pdf">Fitting linear mixed models in R</a> by Brice Ozenne.</p>
<p>I have also set <code>glsControl(tolerance = 10^-8)</code>, this is too match the convergence criteria used by <strong>nlme</strong> to the default convergence criteria used by PROC MIXED in SAS.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/nlme/">nlme</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/glsControl.html">glsControl</a></span><span class="op">(</span>tolerance <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="op">-</span><span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/gls.html">gls</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">atp</span> <span class="op">~</span>  <span class="va">trt</span> <span class="op">+</span> <span class="va">time</span> <span class="op">+</span> <span class="va">trt</span><span class="op">:</span><span class="va">time</span>,</span>
<span>            data <span class="op">=</span> <span class="va">Cardiac_enzyme_data</span>,</span>
<span>            correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/corSymm.html">corSymm</a></span><span class="op">(</span>form <span class="op">=</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">|</span><span class="va">dog</span><span class="op">)</span>,</span>
<span>            weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/varIdent.html">varIdent</a></span><span class="op">(</span>form <span class="op">=</span><span class="op">~</span> <span class="fl">1</span><span class="op">|</span><span class="va">time</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_r</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/gls.html">gls</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">atp</span> <span class="op">~</span> <span class="va">trt</span> <span class="op">+</span> <span class="va">time</span>,</span>
<span>              data <span class="op">=</span> <span class="va">Cardiac_enzyme_data</span>,</span>
<span>              correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/corSymm.html">corSymm</a></span><span class="op">(</span>form <span class="op">=</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">|</span><span class="va">dog</span><span class="op">)</span>,</span>
<span>              weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/varIdent.html">varIdent</a></span><span class="op">(</span>form <span class="op">=</span><span class="op">~</span> <span class="fl">1</span><span class="op">|</span><span class="va">time</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><!-- model_r_2 = gls(model = atp ~ trt + time, -->
<!--               data = Cardiac_enzyme_data, -->
<!--               correlation = corSymm(form =~ as.numeric(time)|dog)) --></p>
<p>We can compare the results from the <code>Box_correction_modified_nlme()</code> function with the results given in the upper panel of Table VII in paper II.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cardiac_mod_box</span> <span class="op">=</span> </span>
<span><span class="fu">Box_correction_modified_nlme</span><span class="op">(</span>data <span class="op">=</span> <span class="va">Cardiac_enzyme_data</span>, model <span class="op">=</span> <span class="va">model</span>, model_r <span class="op">=</span> <span class="va">model_r</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="Modified-Box-Correction.html#cb19-1" aria-hidden="true" tabindex="-1"></a>cardiac_mod_box<span class="sc">$</span>F_MOD</span>
<span id="cb19-2"><a href="Modified-Box-Correction.html#cb19-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">2.520353</span></span>
<span id="cb19-3"><a href="Modified-Box-Correction.html#cb19-3" aria-hidden="true" tabindex="-1"></a>cardiac_mod_box<span class="sc">$</span>prob_F_mod</span>
<span id="cb19-4"><a href="Modified-Box-Correction.html#cb19-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.07743055</span></span></code></pre></div>
<!-- # The part below shows how to calculate other p-values in table VII -->
<!-- In addition to computing the p-value using the modified Box corrected F statistic, we can use the **lmerTest** package to compute some of the other p-values in Table VII.   -->
<!-- The other p-values are computed using Wald tests with the Kenward-Roger adjustment. -->
<!-- Here we  -->
<!-- ```{r} -->
<!-- library(lmerTest) -->
<!-- m1 = lmerTest::lmer(atp ~  trt + time + trt:time + (1|dog), -->
<!--               data = Cardiac_enzyme_data) -->
<!-- m1 = lme4::lmer(atp ~  trt + time + trt:time + (1|dog), -->
<!--               data = Cardiac_enzyme_data) -->
<!-- anova(m1, ddf = "Kenward-Roger") -->
<!-- ``` -->
<!-- The anova method for the S3 method for class 'lmerModLmerTest' uses the KRmodcomp function from the pbkrtest package. And as an alternative to the previous method we can use the KRmodcomp function directly. -->
<!-- ```{r} -->
<!-- library(pbkrtest) -->
<!-- m0 = lme4::lmer(atp ~ trt + time + (1|dog), -->
<!--                 data = Cardiac_enzyme_data) -->
<!-- KRmodcomp(m1,m0) -->
<!-- ``` -->
</div>
<div id="cardiac-enzyme---artifical-missing-data" class="section level3" number="4.2.2">
<h3>
<span class="header-section-number">4.2.2</span> Cardiac enzyme - Artifical missing data<a class="anchor" aria-label="anchor" href="#cardiac-enzyme---artifical-missing-data"><i class="fas fa-link"></i></a>
</h3>
<p>The results in the lower panel of Table VII are computed by applying the same method to the same dataset but now with artificial missing data introduced. The <code>Box_correction_modified_nlme()</code> function works with missing data, and we run it with the modified dataset in the code below.</p>
<p>We first introduce the missing data points to the <code>Cardiac_enzyme_data</code> dataset:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Cardiac_enzyme_data_miss</span> <span class="op">=</span> <span class="va">Cardiac_enzyme_data</span></span>
<span><span class="va">Cardiac_enzyme_data_miss</span><span class="op">$</span><span class="va">atp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">Cardiac_enzyme_data_miss</span><span class="op">$</span><span class="va">dog</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fl">7</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span></code></pre></div>
<p>The code below creates the models with the modified dataset, it is identical to the model construction in the previous example but with the new dataset.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/nlme/">nlme</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/glsControl.html">glsControl</a></span><span class="op">(</span>tolerance <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="op">-</span><span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/gls.html">gls</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">atp</span> <span class="op">~</span>  <span class="va">trt</span> <span class="op">+</span> <span class="va">time</span> <span class="op">+</span> <span class="va">trt</span><span class="op">:</span><span class="va">time</span>,</span>
<span>            data <span class="op">=</span> <span class="va">Cardiac_enzyme_data_miss</span>,</span>
<span>            correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/corSymm.html">corSymm</a></span><span class="op">(</span>form <span class="op">=</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">|</span><span class="va">dog</span><span class="op">)</span>,</span>
<span>            weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/varIdent.html">varIdent</a></span><span class="op">(</span>form <span class="op">=</span><span class="op">~</span> <span class="fl">1</span><span class="op">|</span><span class="va">time</span><span class="op">)</span>, na.action <span class="op">=</span> <span class="va">na.omit</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_r</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/gls.html">gls</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">atp</span> <span class="op">~</span> <span class="va">trt</span> <span class="op">+</span> <span class="va">time</span>,</span>
<span>              data <span class="op">=</span> <span class="va">Cardiac_enzyme_data_miss</span>,</span>
<span>              correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/corSymm.html">corSymm</a></span><span class="op">(</span>form <span class="op">=</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">|</span><span class="va">dog</span><span class="op">)</span>,</span>
<span>              weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/varIdent.html">varIdent</a></span><span class="op">(</span>form <span class="op">=</span><span class="op">~</span> <span class="fl">1</span><span class="op">|</span><span class="va">time</span><span class="op">)</span>, na.action <span class="op">=</span> <span class="va">na.omit</span><span class="op">)</span></span></code></pre></div>
<p>We get the same resuls as the final row of Table VII in paper II:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cardiac_miss_mod_box</span> <span class="op">=</span> </span>
<span><span class="fu">Box_correction_modified_nlme</span><span class="op">(</span>model <span class="op">=</span> <span class="va">model</span>, model_r <span class="op">=</span> <span class="va">model_r</span>, data <span class="op">=</span> <span class="va">Cardiac_enzyme_data_miss</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="Modified-Box-Correction.html#cb23-1" aria-hidden="true" tabindex="-1"></a>cardiac_miss_mod_box<span class="sc">$</span>F_MOD</span>
<span id="cb23-2"><a href="Modified-Box-Correction.html#cb23-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">2.84006</span></span>
<span id="cb23-3"><a href="Modified-Box-Correction.html#cb23-3" aria-hidden="true" tabindex="-1"></a>cardiac_miss_mod_box<span class="sc">$</span>prob_F_mod</span>
<span id="cb23-4"><a href="Modified-Box-Correction.html#cb23-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.05912901</span></span></code></pre></div>
</div>
<div id="Guinea-pigs" class="section level3" number="4.2.3">
<h3>
<span class="header-section-number">4.2.3</span> Guinea pigs<a class="anchor" aria-label="anchor" href="#Guinea-pigs"><i class="fas fa-link"></i></a>
</h3>
<p>In this example we use a dataset that shows the amplitude of action potential that was measured from pieces of heart dissected from guinea pigs. The measurements were taken after being exposed to two different compounds, therefore we have two response variables AP1 and AP2.</p>
<p>Each piece of tissue had a control measure where no compound was given and then six increasing concentrations of the compound. This was carried out on three guinea pigs’ hearts, so we have seven repeated measurements from just three participants.</p>
<p>The code below imports the dataset and converts the concentration variable (<code>conc.f</code>) and subject variable (<code>gpig.f</code>) to factors:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Guinea_pigs_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/DylanDijk/Simon-Skene-Mixed-Models-Tutorial/main/Data_Images_Figures/brammer.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Guinea_pigs_data</span><span class="op">$</span><span class="va">conc.f</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Guinea_pigs_data</span><span class="op">$</span><span class="va">conc.f</span><span class="op">)</span></span>
<span><span class="va">Guinea_pigs_data</span><span class="op">$</span><span class="va">gpig.f</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Guinea_pigs_data</span><span class="op">$</span><span class="va">gpig.f</span><span class="op">)</span></span></code></pre></div>
<p>In this example the experiments are treated as simple repeated measures designs with concentration as the time variable and tissue as the subject.</p>
<p>Due to the small number of samples, the estimation method for the unstructured covariance models did not converge. Therefore, for this example Skene and Kenward used the sample covariance matrix as an estimator of the covariance matrix (<span class="math inline">\(\Sigma\)</span>).</p>
<p>The code below computes the sample covariance estimates for the seven repeated measurements, which are then used as inputs for <code>Sigma</code> in the <code>Box_correction_modified_nlme()</code> function.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_compound_1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">Guinea_pigs_data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span>,<span class="st">"AP1"</span><span class="op">]</span>,<span class="va">Guinea_pigs_data</span><span class="op">[</span><span class="fl">8</span><span class="op">:</span><span class="fl">14</span>,<span class="st">"AP1"</span><span class="op">]</span>,<span class="va">Guinea_pigs_data</span><span class="op">[</span><span class="fl">15</span><span class="op">:</span><span class="fl">21</span>,<span class="st">"AP1"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sigma_compound_2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">Guinea_pigs_data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span>,<span class="st">"AP2"</span><span class="op">]</span>,<span class="va">Guinea_pigs_data</span><span class="op">[</span><span class="fl">8</span><span class="op">:</span><span class="fl">14</span>,<span class="st">"AP2"</span><span class="op">]</span>,<span class="va">Guinea_pigs_data</span><span class="op">[</span><span class="fl">15</span><span class="op">:</span><span class="fl">21</span>,<span class="st">"AP2"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we create the blocked version of these covariance matrices, a block for each of the subjects. To create this covariance matrix we need to know the number of unique subjects in the dataset.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">number_of_subjects</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nlevels.html">nlevels</a></span><span class="op">(</span><span class="va">Guinea_pigs_data</span><span class="op">$</span><span class="va">gpig.f</span><span class="op">)</span> <span class="co">#number of subjects</span></span>
<span> </span>
<span><span class="va">sigma_compound_1_block</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">number_of_subjects</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/kronecker.html">%x%</a></span> <span class="va">sigma_compound_1</span></span>
<span><span class="va">sigma_compound_2_block</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">number_of_subjects</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/kronecker.html">%x%</a></span> <span class="va">sigma_compound_2</span></span></code></pre></div>
<p>Next we construct the models, we make a model for each of the response variables with concentration (<code>conc.f</code>) as the only covariate.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/nlme/">nlme</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_AP1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/gls.html">gls</a></span><span class="op">(</span><span class="va">AP1</span><span class="op">~</span><span class="va">conc.f</span>,data<span class="op">=</span><span class="va">Guinea_pigs_data</span><span class="op">)</span></span>
<span><span class="va">model_AP1_r</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/gls.html">gls</a></span><span class="op">(</span><span class="va">AP1</span><span class="op">~</span><span class="fl">1</span>,data<span class="op">=</span><span class="va">Guinea_pigs_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_AP2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/gls.html">gls</a></span><span class="op">(</span><span class="va">AP2</span><span class="op">~</span><span class="va">conc.f</span>,data<span class="op">=</span><span class="va">Guinea_pigs_data</span><span class="op">)</span></span>
<span><span class="va">model_AP2_r</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/gls.html">gls</a></span><span class="op">(</span><span class="va">AP2</span><span class="op">~</span><span class="fl">1</span>,data<span class="op">=</span><span class="va">Guinea_pigs_data</span><span class="op">)</span></span></code></pre></div>
<p>Below we run the <code>Box_correction_modified_nlme()</code> function, using the model objects we have created above as inputs.</p>
<ul>
<li>For compound 1.</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Box_mod_1</span> <span class="op">=</span></span>
<span><span class="fu">Box_correction_modified_nlme</span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_AP1</span>, model_r <span class="op">=</span> <span class="va">model_AP1_r</span>, data <span class="op">=</span> <span class="va">Guinea_pigs_data</span>, Sigma <span class="op">=</span> <span class="va">sigma_compound_1_block</span><span class="op">)</span></span></code></pre></div>
<p>This gives the following output:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="Modified-Box-Correction.html#cb29-1" aria-hidden="true" tabindex="-1"></a>Box_mod_1<span class="sc">$</span>F_MOD</span>
<span id="cb29-2"><a href="Modified-Box-Correction.html#cb29-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">4.497613</span></span>
<span id="cb29-3"><a href="Modified-Box-Correction.html#cb29-3" aria-hidden="true" tabindex="-1"></a>Box_mod_1<span class="sc">$</span>prob_F_mod</span>
<span id="cb29-4"><a href="Modified-Box-Correction.html#cb29-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.05698665</span></span></code></pre></div>
<ul>
<li>For compound 2.</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Box_mod_2</span> <span class="op">=</span> <span class="fu">Box_correction_modified_nlme</span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_AP2</span>, model_r <span class="op">=</span> <span class="va">model_AP2_r</span>, data <span class="op">=</span> <span class="va">Guinea_pigs_data</span>, Sigma <span class="op">=</span> <span class="va">sigma_compound_2_block</span><span class="op">)</span></span></code></pre></div>
<p>For compound 2, we get these values:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="Modified-Box-Correction.html#cb31-1" aria-hidden="true" tabindex="-1"></a>Box_mod_2<span class="sc">$</span>F_MOD</span>
<span id="cb31-2"><a href="Modified-Box-Correction.html#cb31-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">20.84697</span></span>
<span id="cb31-3"><a href="Modified-Box-Correction.html#cb31-3" aria-hidden="true" tabindex="-1"></a>Box_mod_2<span class="sc">$</span>prob_F_mod</span>
<span id="cb31-4"><a href="Modified-Box-Correction.html#cb31-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.001995718</span></span></code></pre></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="Sandwich-Estimator.html"><span class="header-section-number">3</span> Sandwich Estimator</a></div>
<div class="next"><a href="Scheffe-method.html"><span class="header-section-number">5</span> Scheffé’s method</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#Modified-Box-Correction"><span class="header-section-number">4</span> Modified Box Correction</a></li>
<li><a class="nav-link" href="#nlme"><span class="header-section-number">4.1</span> nlme</a></li>
<li>
<a class="nav-link" href="#examples"><span class="header-section-number">4.2</span> Examples</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#cardiac-enzyme-1"><span class="header-section-number">4.2.1</span> Cardiac enzyme</a></li>
<li><a class="nav-link" href="#cardiac-enzyme---artifical-missing-data"><span class="header-section-number">4.2.2</span> Cardiac enzyme - Artifical missing data</a></li>
<li><a class="nav-link" href="#Guinea-pigs"><span class="header-section-number">4.2.3</span> Guinea pigs</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/DylanDijk/Simon-Skene-Mixed-Models-Tutorial/blob/main/03-mod_box_R.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/DylanDijk/Simon-Skene-Mixed-Models-Tutorial/edit/main/03-mod_box_R.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Methods in (Skene &amp; Kenward, 2010)</strong>" was written by Dylan Dijk. It was last built on 2022-09-09.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
